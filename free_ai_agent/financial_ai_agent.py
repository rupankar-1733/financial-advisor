# free_ai_agent/financial_ai_agent.py - Your FREE AI Financial Advisor
import os
import sys
import json
import re
from datetime import datetime
import requests

# Add project paths
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# Import your existing trading systems
from strategies.working_zones_system import WorkingZoneDetector
from data_sources.comprehensive_intelligence_system import UltimateMarketIntelligence
from utils.live_data_fetcher import LiveDataFetcher

class FreeFinancialAI:
    def __init__(self, use_local_llm=True):
        """Initialize your FREE Financial AI Agent"""
        self.use_local_llm = use_local_llm
        
        # Initialize your trading systems
        self.zone_detector = WorkingZoneDetector
        self.market_intel = UltimateMarketIntelligence()
        self.data_fetcher = LiveDataFetcher()
        
        # Your AI's financial knowledge base
        self.financial_knowledge = {
            'risk_management_rules': [
                "Never risk more than 2% of capital per trade",
                "Always set stop losses below support levels",
                "Position size based on distance to stop loss",
                "Diversify across maximum 5-6 stocks",
                "Keep 20% cash for opportunities"
            ],
            'technical_analysis_rules': [
                "Buy near support zones with volume confirmation",
                "Sell near resistance zones or take partial profits",
                "Follow trend direction - trend is your friend",
                "Wait for price to reach key zones before entering",
                "Use multiple timeframes for confirmation"
            ],
            'investment_principles': [
                "Invest in companies with strong fundamentals",
                "Dollar cost average in volatile markets",
                "Hold quality stocks for long term",
                "Rebalance portfolio quarterly",
                "Stay updated with company earnings and news"
            ],
            'indian_stock_insights': [
                "TCS: IT giant, stable growth, dividend paying",
                "RELIANCE: Oil to telecom, high beta stock",
                "INFY: Global IT services, US revenue exposure",
                "HDFCBANK: Leading private bank, NPA concerns watch",
                "ITC: FMCG + tobacco, regulatory risks"
            ]
        }
        
        # Conversation memory
        self.conversation_history = []
        
        print("ü§ñ FREE Financial AI Agent Initialized!")
        if use_local_llm:
            print("üîß Using local LLM - completely FREE!")
        else:
            print("üåê Using rule-based responses")
    
    def analyze_stock_with_tools(self, symbol, capital=50000):
        """Analyze stock using your advanced tools"""
        try:
            print(f"üîç Analyzing {symbol} with ‚Çπ{capital:,} capital...")
            
            detector = self.zone_detector(symbol, capital)
            zones_data = detector.get_price_zones()
            
            if not zones_data:
                return f"Unable to analyze {symbol} - insufficient data"
            
            # Extract key analysis points
            analysis = {
                'symbol': symbol.replace('.NS', ''),
                'current_price': zones_data['current_price'],
                'max_shares': int(capital / zones_data['current_price']),
                'best_support': zones_data['support_zones'][0] if zones_data['support_zones'] else None,
                'best_resistance': zones_data['resistance_zones'][0] if zones_data['resistance_zones'] else None,
                'support_count': len(zones_data['support_zones']),
                'resistance_count': len(zones_data['resistance_zones'])
            }
            
            return analysis
            
        except Exception as e:
            return f"Analysis failed: {e}"
    
    def get_investment_recommendation(self, user_query, user_profile=None):
        """Generate investment recommendations based on query analysis"""
        
        # Extract key information from user query
        query_analysis = self.analyze_user_query(user_query)
        
        # Get stock analysis if specific stocks mentioned
        stock_data = {}
        if query_analysis['stocks_mentioned']:
            for stock in query_analysis['stocks_mentioned'][:2]:  # Limit to 2 stocks
                capital = user_profile.get('capital', 50000) if user_profile else 50000
                stock_data[stock] = self.analyze_stock_with_tools(stock, capital)
        
        # Generate personalized response
        response = self.generate_financial_response(query_analysis, stock_data, user_profile)
        
        return response
    
    def analyze_user_query(self, query):
        """Analyze user query to understand intent and extract information"""
        query_lower = query.lower()
        
        # Extract stocks mentioned
        stocks_mentioned = []
        stock_symbols = ['tcs', 'infy', 'reliance', 'hdfcbank', 'itc', 'hindunilvr', 'sbin']
        for symbol in stock_symbols:
            if symbol in query_lower:
                stocks_mentioned.append(f"{symbol.upper()}.NS")
        
        # Determine query type
        query_type = 'general'
        if any(word in query_lower for word in ['buy', 'invest', 'should i']):
            query_type = 'investment_advice'
        elif any(word in query_lower for word in ['trade', 'trading', 'short term']):
            query_type = 'trading_advice'
        elif any(word in query_lower for word in ['analyze', 'analysis', 'target', 'support']):
            query_type = 'technical_analysis'
        elif any(word in query_lower for word in ['risk', 'stop loss', 'position size']):
            query_type = 'risk_management'
        elif any(word in query_lower for word in ['market', 'sentiment', 'today']):
            query_type = 'market_overview'
        
        # Extract mentioned capital amount
        capital_mentioned = None
        capital_patterns = [r'‚Çπ(\d+(?:,\d+)*(?:k|l|cr)?)', r'(\d+)k', r'(\d+)l', r'(\d+)\s*lakh']
        for pattern in capital_patterns:
            match = re.search(pattern, query_lower)
            if match:
                amount_str = match.group(1).replace(',', '')
                if 'k' in query_lower:
                    capital_mentioned = int(float(amount_str)) * 1000
                elif 'l' in query_lower or 'lakh' in query_lower:
                    capital_mentioned = int(float(amount_str)) * 100000
                else:
                    capital_mentioned = int(float(amount_str))
                break
        
        return {
            'query_type': query_type,
            'stocks_mentioned': stocks_mentioned,
            'capital_mentioned': capital_mentioned,
            'original_query': query
        }
    
    def generate_financial_response(self, query_analysis, stock_data, user_profile):
        """Generate comprehensive financial response"""
        
        query_type = query_analysis['query_type']
        stocks = query_analysis['stocks_mentioned']
        capital = query_analysis['capital_mentioned'] or (user_profile.get('capital', 50000) if user_profile else 50000)
        
        # Start building response
        response = f"ü§ñ **AI Financial Advisor Analysis**\n\n"
        
        if query_type == 'investment_advice':
            response += self.generate_investment_advice(stocks, stock_data, capital, user_profile)
        elif query_type == 'trading_advice':
            response += self.generate_trading_advice(stocks, stock_data, capital)
        elif query_type == 'technical_analysis':
            response += self.generate_technical_analysis(stocks, stock_data)
        elif query_type == 'risk_management':
            response += self.generate_risk_management_advice(capital, user_profile)
        elif query_type == 'market_overview':
            response += self.generate_market_overview()
        else:
            response += self.generate_general_advice()
        
        # Add personalized footer
        if user_profile:
            risk_level = user_profile.get('risk_tolerance', 'moderate')
            response += f"\n\nüí° **Note**: Advice tailored for {risk_level} risk profile with ‚Çπ{capital:,} capital."
        
        response += "\n\n‚ö†Ô∏è **Disclaimer**: This is educational content only. Please do your own research before investing."
        
        return response
    
    def generate_investment_advice(self, stocks, stock_data, capital, user_profile):
        """Generate investment-specific advice"""
        advice = f"üí∞ **Investment Strategy (‚Çπ{capital:,} Capital)**\n\n"
        
        if stocks and stock_data:
            for stock in stocks:
                if stock in stock_data and isinstance(stock_data[stock], dict):
                    data = stock_data[stock]
                    stock_name = data['symbol']
                    current_price = data['current_price']
                    max_shares = data['max_shares']
                    
                    advice += f"üìä **{stock_name} Analysis:**\n"
                    advice += f"   üí∞ Current Price: ‚Çπ{current_price:.2f}\n"
                    advice += f"   üìà Max Shares for Capital: {max_shares}\n"
                    
                    # Position sizing recommendation
                    recommended_allocation = min(capital * 0.2, capital // len(stocks))  # Max 20% per stock
                    recommended_shares = int(recommended_allocation / current_price)
                    
                    advice += f"   üéØ Recommended Investment: ‚Çπ{recommended_allocation:,.0f} ({recommended_shares} shares)\n"
                    
                    if data['best_support']:
                        support_price = data['best_support']['price']
                        advice += f"   üîª Key Support: ‚Çπ{support_price:.0f} (good entry zone)\n"
                    
                    if data['best_resistance']:
                        resistance_price = data['best_resistance']['price']
                        expected_return = ((resistance_price - current_price) / current_price) * 100
                        advice += f"   üî∫ Target: ‚Çπ{resistance_price:.0f} ({expected_return:.1f}% upside)\n"
                    
                    advice += "\n"
        else:
            # General investment advice
            advice += "üéØ **General Investment Guidelines:**\n\n"
            for principle in self.financial_knowledge['investment_principles']:
                advice += f"   ‚Ä¢ {principle}\n"
            
            advice += f"\nüí° **For ‚Çπ{capital:,} capital, consider:**\n"
            advice += "   ‚Ä¢ Diversify across 3-5 quality stocks\n"
            advice += "   ‚Ä¢ Allocate max ‚Çπ10,000-15,000 per stock\n"
            advice += "   ‚Ä¢ Keep 20% cash for opportunities\n"
            advice += "   ‚Ä¢ Focus on fundamentally strong companies\n"
        
        return advice
    
    def generate_trading_advice(self, stocks, stock_data, capital):
        """Generate trading-specific advice"""
        advice = f"‚ö° **Trading Strategy (‚Çπ{capital:,} Capital)**\n\n"
        
        if stocks and stock_data:
            for stock in stocks:
                if stock in stock_data and isinstance(stock_data[stock], dict):
                    data = stock_data[stock]
                    stock_name = data['symbol']
                    current_price = data['current_price']
                    
                    advice += f"üìä **{stock_name} Trading Setup:**\n"
                    
                    if data['best_support'] and data['best_resistance']:
                        support = data['best_support']['price']
                        resistance = data['best_resistance']['price']
                        
                        # Calculate risk-reward
                        stop_loss = support * 0.98  # 2% below support
                        risk_per_share = current_price - stop_loss
                        reward_per_share = resistance - current_price
                        rr_ratio = reward_per_share / risk_per_share if risk_per_share > 0 else 0
                        
                        # Position sizing (2% portfolio risk)
                        risk_amount = capital * 0.02
                        position_size = int(risk_amount / risk_per_share) if risk_per_share > 0 else 0
                        
                        advice += f"   üéØ Entry: Wait for ‚Çπ{support:.0f} zone\n"
                        advice += f"   üî∫ Target: ‚Çπ{resistance:.0f}\n"
                        advice += f"   üõë Stop Loss: ‚Çπ{stop_loss:.0f}\n"
                        advice += f"   ‚öñÔ∏è Risk:Reward = 1:{rr_ratio:.1f}\n"
                        advice += f"   üìä Position Size: {position_size} shares\n"
                        advice += f"   üí∞ Investment: ‚Çπ{position_size * support:,.0f}\n"
                        
                        if rr_ratio >= 3:
                            advice += f"   ‚úÖ **Excellent trade setup!**\n"
                        elif rr_ratio >= 2:
                            advice += f"   üü° **Good trade setup**\n"
                        else:
                            advice += f"   üî¥ **Poor risk-reward - avoid**\n"
                    
                    advice += "\n"
        else:
            advice += "‚ö° **Key Trading Principles:**\n\n"
            for rule in self.financial_knowledge['technical_analysis_rules']:
                advice += f"   ‚Ä¢ {rule}\n"
        
        return advice
    
    def generate_technical_analysis(self, stocks, stock_data):
        """Generate technical analysis"""
        analysis = "üìä **Technical Analysis**\n\n"
        
        if stocks and stock_data:
            for stock in stocks:
                if stock in stock_data and isinstance(stock_data[stock], dict):
                    data = stock_data[stock]
                    stock_name = data['symbol']
                    
                    analysis += f"üéØ **{stock_name} Technical View:**\n"
                    analysis += f"   üìä Support Levels: {data['support_count']} identified\n"
                    analysis += f"   üìä Resistance Levels: {data['resistance_count']} identified\n"
                    
                    if data['best_support']:
                        support = data['best_support']
                        analysis += f"   üîª Strongest Support: ‚Çπ{support['price']:.0f} ({support['method']})\n"
                    
                    if data['best_resistance']:
                        resistance = data['best_resistance']
                        analysis += f"   üî∫ Strongest Resistance: ‚Çπ{resistance['price']:.0f} ({resistance['method']})\n"
                    
                    analysis += "\n"
        
        return analysis
    
    def generate_risk_management_advice(self, capital, user_profile):
        """Generate risk management advice"""
        advice = f"üõ°Ô∏è **Risk Management (‚Çπ{capital:,} Portfolio)**\n\n"
        
        max_risk_per_trade = capital * 0.02
        max_position_size = capital * 0.2
        emergency_fund = capital * 0.1
        
        advice += f"üìã **Your Risk Parameters:**\n"
        advice += f"   ‚Ä¢ Max risk per trade: ‚Çπ{max_risk_per_trade:,.0f} (2%)\n"
        advice += f"   ‚Ä¢ Max position size: ‚Çπ{max_position_size:,.0f} (20%)\n"
        advice += f"   ‚Ä¢ Emergency fund: ‚Çπ{emergency_fund:,.0f} (10%)\n\n"
        
        advice += "üéØ **Risk Management Rules:**\n"
        for rule in self.financial_knowledge['risk_management_rules']:
            advice += f"   ‚Ä¢ {rule}\n"
        
        return advice
    
    def generate_market_overview(self):
        """Generate market overview"""
        overview = "üåç **Market Overview**\n\n"
        
        try:
            # Get basic market status
            status = self.data_fetcher.get_current_market_status()
            
            overview += f"üìä **Market Status**: {'üü¢ OPEN' if status['is_open'] else 'üî¥ CLOSED'}\n"
            overview += f"üïí **Current Time**: {status['current_time']}\n\n"
            
            overview += "üí° **Current Market Themes:**\n"
            overview += "   ‚Ä¢ Focus on quality stocks with strong earnings\n"
            overview += "   ‚Ä¢ Monitor global cues and FII/DII flows\n"
            overview += "   ‚Ä¢ Sector rotation from growth to value\n"
            overview += "   ‚Ä¢ Volatility expected around major events\n"
            
        except:
            overview += "üìä Market analysis temporarily unavailable\n"
        
        return overview
    
    def generate_general_advice(self):
        """Generate general financial advice"""
        advice = "üí° **General Financial Guidance**\n\n"
        advice += "I can help you with:\n"
        advice += "   üìä Stock analysis and recommendations\n"
        advice += "   üí∞ Investment strategies and portfolio allocation\n"
        advice += "   ‚ö° Trading setups with entry/exit points\n"
        advice += "   üõ°Ô∏è Risk management and position sizing\n"
        advice += "   üìà Technical analysis and support/resistance levels\n\n"
        advice += "üí¨ **Try asking:**\n"
        advice += "   ‚Ä¢ 'Analyze TCS for ‚Çπ50k investment'\n"
        advice += "   ‚Ä¢ 'Should I buy RELIANCE for trading?'\n"
        advice += "   ‚Ä¢ 'What's my risk for ‚Çπ1L portfolio?'\n"
        advice += "   ‚Ä¢ 'Give me 3 good stocks to invest'\n"
        
        return advice
    
    def chat(self, user_input, user_profile=None):
        """Main chat interface"""
        print(f"üë§ User: {user_input}")
        
        # Generate response
        response = self.get_investment_recommendation(user_input, user_profile)
        
        # Store in conversation history
        self.conversation_history.append({
            'user': user_input,
            'ai': response,
            'timestamp': datetime.now()
        })
        
        print(f"\nü§ñ AI Financial Advisor:\n{response}")
        
        return response

def start_free_financial_ai():
    """Start the FREE Financial AI Agent"""
    print("üöÄ === FREE AI FINANCIAL ADVISOR ===")
    print("üí° Powered by your advanced trading algorithms!")
    print("=" * 60)
    
    # Initialize AI agent
    ai_agent = FreeFinancialAI()
    
    # Get user profile
    print("\nüìã Let's set up your investment profile:")
    try:
        capital = int(input("üí∞ Investment capital (‚Çπ): "))
    except:
        capital = 50000
    
    risk_tolerance = input("üéØ Risk tolerance (conservative/moderate/aggressive): ").lower() or 'moderate'
    
    user_profile = {
        'capital': capital,
        'risk_tolerance': risk_tolerance,
        'setup_time': datetime.now()
    }
    
    print(f"\n‚úÖ Profile created! Capital: ‚Çπ{capital:,}, Risk: {risk_tolerance}")
    print("\nüí¨ Start asking questions! (type 'quit' to exit)")
    print("="*60)
    
    # Chat loop
    while True:
        try:
            user_input = input(f"\nüë§ You: ").strip()
            
            if user_input.lower() in ['quit', 'exit', 'bye']:
                print("üëã Thank you for using FREE AI Financial Advisor!")
                break
            
            if not user_input:
                continue
            
            # Get AI response
            response = ai_agent.chat(user_input, user_profile)
            
        except KeyboardInterrupt:
            print("\nüëã Goodbye!")
            break
        except Exception as e:
            print(f"‚ùå Error: {e}")

if __name__ == "__main__":
    start_free_financial_ai()
